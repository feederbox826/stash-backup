# Maintainer: Carlo Landmeter <clandmeter@alpinelinux.org>
# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
pkgname=sqldiff
# NOTE: pkgver needs to correspond with sqlite-tcl
pkgver=3.45.3
pkgrel=0
pkgdesc="sqlite3 database difference utility"
url="https://www.sqlite.org/"
arch="all"
license="blessing"
depends="sqlite"
depends_dev="$pkgname=$pkgver-r$pkgrel sqlite-dev"
makedepends="readline-dev tcl"
subpackages="$pkgname-doc"
options="!check"

# compute _ver
_a=${pkgver%%.*}
_b=${pkgver#"$_a".}
_b=${_b%%.*}
_c=${pkgver#"$_a"."$_b".}
_c=${_c%%.*}
case $pkgver in
        *.*.*.*)_d=${pkgver##*.};;
        *.*.*)  _d=0;;
esac
[ $_b -lt 10 ] && _b=0$_b
[ $_c -lt 10 ] && _c=0$_c
[ $_d -lt 10 ] && _d=0$_d
_ver=${_a}${_b}${_c}$_d

# these variables depend on _ver being set
builddir="$srcdir/sqlite-src-$_ver"
source="https://www.sqlite.org/2024/sqlite-src-$_ver.zip
        $pkgname-$_ver-LICENSE.md::https://www.sqlite.org/src/raw?name=LICENSE.md&ci=version-$pkgver
        "

prepare() {
        if [ -f "$startdir"/../sqlite-tcl/APKBUILD ]; then
                (
                _sqlitever=$pkgver
                . "$startdir"/../sqlite-tcl/APKBUILD
                if [ "$_sqlitever" != "$pkgver" ]; then
                        warning "sqlite-tcl version mismatch ($_sqlitever != $pkgver)"
                fi
                )
        fi
        if [ -f "$startdir"/../sqlite-tcl/APKBUILD ]; then
                (
                _sqlitever=$pkgver
                . "$startdir"/../sqlite-tcl/APKBUILD
                if [ "$_sqlitever" != "$pkgver" ]; then
                        warning "sqlite-tcl version mismatch ($_sqlitever != $pkgver)"
                fi
                )
        fi

        default_prepare
}

build() {
        export CFLAGS="$CFLAGS -O2"
        ./configure \
                --build="$CBUILD" \
                --host="$CHOST" \
                --prefix=/usr \
                --enable-threadsafe \
                --enable-readline \
                --enable-dynamic-extensions \
                --enable-fts3 \
                --enable-fts4 \
                --enable-fts5

        # rpath removal
        sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
        sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool

        make sqldiff
}



package() {
        install -Dm0755 sqldiff "$pkgdir"/usr/bin/sqldiff

        install -Dm0644 sqlite3.1 \
                "$pkgdir"/usr/share/man/man1/sqldiff.1
        install -Dm644 "$srcdir"/$pkgname-$_ver-LICENSE.md \
                "$pkgdir"/usr/share/licenses/$pkgname/LICENSE.md
}

sha512sums="
8f44ffdefd2cf09e7edb7cd78d5416fe7b42e01fe4b4e4803ce9d34c7b1b2971ec170a908a94b4bb11737dd3888675c8ff101ff2b41c53b8db05b5954e947cc9  sqlite-src-3450300.zip
8a347c292363e55a8c0fa0321e3f399bfe9c9aedcb6c838123f0eb3e2a4e078d096b7c152a4981e18ee9fa50c4ef913a33ed840aeed33aee0a46e95cd17f0814  sqlite-3450300-LICENSE.md
"